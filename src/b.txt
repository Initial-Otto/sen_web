-- 创建数据库，并明确设置字符集为utf8mb4以支持中文存储[6,8](@ref)
CREATE DATABASE IF NOT EXISTS forum_db
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE forum_db;

-- 1. 用户表 (Users)
CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '用户唯一标识ID',
    account VARCHAR(50) UNIQUE NOT NULL COMMENT '用户账号',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    email VARCHAR(100) UNIQUE COMMENT '邮箱地址',
    password_hash CHAR(60) NOT NULL COMMENT '加密后的密码',
    experience INT DEFAULT 0 COMMENT '经验值',
    level INT DEFAULT 1 COMMENT '用户等级',
    avatar_path VARCHAR(255) COMMENT '头像图片存储路径',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '账号注册时间',
    INDEX idx_email (email),
    INDEX idx_account (account)
) ENGINE=InnoDB COMMENT='存储论坛用户的基本信息';

-- 2. 帖子表 (Posts)
CREATE TABLE posts (
    post_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '帖子唯一标识ID',
    user_id INT NOT NULL COMMENT '发帖用户ID',
    title VARCHAR(200) NOT NULL COMMENT '帖子标题',
    section_id INT COMMENT '帖子所属版块ID',
    status TINYINT DEFAULT 1 COMMENT '帖子状态:1-置顶 2-正常 3-删除 4-待审核',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '发帖时间',
    last_replied_at DATETIME COMMENT '最后回复时间',
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_section_status (section_id, status)
) ENGINE=InnoDB COMMENT='存储帖子的元数据信息';

-- 3. 帖子内容表 (Post_Contents)
CREATE TABLE post_contents (
    post_id INT PRIMARY KEY COMMENT '与帖子ID关联',
    content_text LONGTEXT COMMENT '帖子的详细文本内容',
    image_path VARCHAR(255) COMMENT '帖子附带的单张图片路径',
    width INT COMMENT '帖子照片真实宽度'
    height INT COMMENT '帖子照片真实高度'
    FULLTEXT INDEX idx_fulltext_content (content_text), -- 全文搜索索引
    FOREIGN KEY (post_id) REFERENCES posts(post_id) ON DELETE CASCADE
) ENGINE=InnoDB COMMENT='存储帖子的正文内容和图片信息，与帖子主表分开以优化性能';

-- 4. 评论表 (Comments)
CREATE TABLE comments (
    comment_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '评论唯一标识ID',
    post_id INT NOT NULL COMMENT '所属帖子ID',
    user_id INT NOT NULL COMMENT '评论用户ID',
    floor_number INT COMMENT '评论在帖子中的楼层号',
    content_text TEXT COMMENT '评论的文本内容',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '评论时间',
    FOREIGN KEY (post_id) REFERENCES posts(post_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    INDEX idx_post_id (post_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='存储用户对帖子的评论';

-- 5. 收藏表 (Favorites)
CREATE TABLE favorites (
    user_id INT COMMENT '收藏用户ID',
    post_id INT COMMENT '被收藏的帖子ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
    PRIMARY KEY (user_id, post_id), -- 联合主键，防止重复收藏
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (post_id) REFERENCES posts(post_id) ON DELETE CASCADE,
    INDEX idx_user_fav (user_id, created_at) COMMENT '用于快速查询用户的收藏列表'
) ENGINE=InnoDB COMMENT='记录用户收藏帖子的关系';